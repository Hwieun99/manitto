<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆë‹ˆë˜ ë½‘ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-pink-100 to-purple-100 min-h-screen">
    <div id="app"></div>

    <script>
        const app = {
            step: 'setup',
            participants: [{name: ''}],
            links: [],
            copied: {},
            viewPassword: '',
            result: null,
            error: ''
        };

        function shuffle(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function addParticipant() {
            // í˜„ì¬ ì…ë ¥ê°’ ì €ì¥
            app.participants.forEach((_, index) => {
                const nameInput = document.getElementById(`name-${index}`);
                if (nameInput) app.participants[index].name = nameInput.value;
            });
            
            app.participants.push({name: ''});
            render();
        }

        function removeParticipant(index) {
            // í˜„ì¬ ì…ë ¥ê°’ ì €ì¥
            app.participants.forEach((_, i) => {
                const nameInput = document.getElementById(`name-${i}`);
                if (nameInput) app.participants[i].name = nameInput.value;
            });
            
            app.participants = app.participants.filter((_, i) => i !== index);
            render();
        }

        function updateParticipantName(index) {
            const input = document.getElementById(`name-${index}`);
            app.participants[index].name = input.value;
        }

        // Base64 ì¸ì½”ë”© (í•œê¸€ ì§€ì›, URL-safe)
        function encodeBase64(str) {
            return btoa(unescape(encodeURIComponent(str)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        // Base64 ë””ì½”ë”© (í•œê¸€ ì§€ì›, URL-safe)
        function decodeBase64(str) {
            str = str.replace(/-/g, '+').replace(/_/g, '/');
            while (str.length % 4) {
                str += '=';
            }
            return decodeURIComponent(escape(atob(str)));
        }

        function generateMatching() {
            // ì…ë ¥ê°’ ìµœì¢… ì—…ë°ì´íŠ¸
            app.participants.forEach((_, index) => {
                updateParticipantName(index);
            });

            const validParticipants = app.participants.filter(p => p.name.trim() !== '');
            
            if (validParticipants.length < 2) {
                alert('ì°¸ê°€ìê°€ ìµœì†Œ 2ëª… ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤!');
                return;
            }

            const names = validParticipants.map(p => p.name);
            let receivers = shuffle(names);
            
            for (let i = 0; i < names.length; i++) {
                if (names[i] === receivers[i]) {
                    const nextIndex = (i + 1) % names.length;
                    [receivers[i], receivers[nextIndex]] = [receivers[nextIndex], receivers[i]];
                }
            }

            const currentUrl = window.location.href.split('?')[0];
            app.links = validParticipants.map((participant, index) => {
                const receiver = receivers[index];
                
                // ë°ì´í„°ë¥¼ URLì— ì§ì ‘ ì¸ì½”ë”©
                const data = JSON.stringify({ 
                    giver: participant.name, 
                    receiver: receiver
                });
                const encoded = encodeBase64(data);
                
                return {
                    name: participant.name,
                    url: `${currentUrl}?data=${encoded}`
                };
            });

            app.step = 'links';
            render();
        }

        function copyLink(url) {
            navigator.clipboard.writeText(url).then(() => {
                app.copied[url] = true;
                render();
                setTimeout(() => {
                    app.copied[url] = false;
                    render();
                }, 2000);
            });
        }

        function viewManitto() {
            const input = document.getElementById('viewPasswordInput');
            const inputName = input ? input.value.trim() : '';

            const params = new URLSearchParams(window.location.search);
            const encodedData = params.get('data');
            
            if (!encodedData) {
                app.error = 'ìœ íš¨í•˜ì§€ ì•Šì€ ë§í¬ì…ë‹ˆë‹¤.';
                render();
                return;
            }

            try {
                const decoded = decodeBase64(encodedData);
                const { giver, receiver } = JSON.parse(decoded);

                if (inputName !== giver.trim()) {
                    app.error = 'ì´ë¦„ì´ í‹€ë ¸ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                    render();
                    return;
                }

                app.result = { giver, receiver };
                app.error = '';
                render();
            } catch (e) {
                app.error = 'ì˜ëª»ëœ ë§í¬ì…ë‹ˆë‹¤.';
                render();
            }
        }

        function reset() {
            app.step = 'setup';
            app.participants = [{name: ''}];
            app.links = [];
            app.copied = {};
            app.viewPassword = '';
            app.result = null;
            app.error = '';
            window.history.pushState({}, '', window.location.pathname);
            render();
        }

        function render() {
            const container = document.getElementById('app');
            
            if (app.step === 'view') {
                if (app.result) {
                    container.innerHTML = `
                        <div class="min-h-screen flex items-center justify-center p-4">
                            <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
                                <div class="w-20 h-20 mx-auto mb-6">
                                    <svg class="w-full h-full text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path>
                                    </svg>
                                </div>
                                <h1 class="text-3xl font-bold text-gray-800 mb-4">
                                    ${app.result.giver}ë‹˜ì˜ ë§ˆë‹ˆë˜ëŠ”
                                </h1>
                                <div class="bg-gradient-to-r from-pink-500 to-purple-500 text-white rounded-xl p-6 mb-6">
                                    <p class="text-4xl font-bold">${app.result.receiver}</p>
                                </div>
                                <p class="text-gray-600 mb-6">ì…ë‹ˆë‹¤! ğŸ</p>
                                <button onclick="reset()" class="text-purple-600 hover:text-purple-700 font-medium">
                                    ìƒˆë¡œìš´ ë§ˆë‹ˆë˜ ë§Œë“¤ê¸°
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="min-h-screen flex items-center justify-center p-4">
                            <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                                <div class="w-16 h-16 mx-auto mb-6">
                                    <svg class="w-full h-full text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path>
                                    </svg>
                                </div>
                                <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">
                                    ë‚´ ë§ˆë‹ˆë˜ í™•ì¸í•˜ê¸°
                                </h1>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”
                                        </label>
                                        <input
                                            type="text"
                                            id="viewPasswordInput"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                            placeholder="ë³¸ì¸ ì´ë¦„"
                                            onkeypress="if(event.key==='Enter') viewManitto()"
                                        />
                                    </div>

                                    ${app.error ? `
                                        <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                                            ${app.error}
                                        </div>
                                    ` : ''}

                                    <button
                                        onclick="viewManitto()"
                                        class="w-full bg-gradient-to-r from-pink-500 to-purple-500 text-white py-3 rounded-lg font-semibold hover:from-pink-600 hover:to-purple-600 transition"
                                    >
                                        ë§ˆë‹ˆë˜ í™•ì¸í•˜ê¸°
                                    </button>

                                    <button
                                        onclick="reset()"
                                        class="w-full text-gray-600 hover:text-gray-800 py-2 text-sm"
                                    >
                                        ìƒˆë¡œìš´ ë§ˆë‹ˆë˜ ë§Œë“¤ê¸°
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } else if (app.step === 'links') {
                container.innerHTML = `
                    <div class="p-4 py-8">
                        <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl p-8">
                            <div class="w-16 h-16 mx-auto mb-6 bg-purple-100 rounded-full flex items-center justify-center">
                                <svg class="w-8 h-8 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                                </svg>
                            </div>
                            <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">
                                ë§í¬ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!
                            </h1>
                            <p class="text-center text-gray-600 mb-8">
                                ê° ì°¸ê°€ìì—ê²Œ ê°œì¸ í†¡ìœ¼ë¡œ ë§í¬ë¥¼ ë³´ë‚´ì£¼ì„¸ìš”
                            </p>

                            <div class="space-y-3 mb-8">
                                ${app.links.map(link => `
                                    <div class="bg-gray-50 rounded-lg p-4 flex items-center justify-between">
                                        <div class="flex-1 min-w-0">
                                            <p class="font-semibold text-gray-800 mb-1">${link.name}</p>
                                            <p class="text-xs text-gray-500 break-all">${link.url}</p>
                                        </div>
                                        <button
                                            onclick='copyLink(\`${link.url}\`)'
                                            class="ml-4 flex items-center gap-2 bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition whitespace-nowrap flex-shrink-0"
                                        >
                                            ${app.copied[link.url] ? `
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                </svg>
                                                ë³µì‚¬ë¨
                                            ` : `
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                                </svg>
                                                ë³µì‚¬
                                            `}
                                        </button>
                                    </div>
                                `).join('')}
                            </div>

                            <button
                                onclick="reset()"
                                class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition"
                            >
                                ìƒˆë¡œìš´ ë§ˆë‹ˆë˜ ë§Œë“¤ê¸°
                            </button>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="p-4 py-8">
                        <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl p-8">
                            <div class="w-16 h-16 mx-auto mb-6">
                                <svg class="w-full h-full text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                </svg>
                            </div>
                            <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">
                                ë§ˆë‹ˆë˜ ë½‘ê¸°
                            </h1>
                            <p class="text-center text-gray-600 mb-8">
                                ì°¸ê°€ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”
                            </p>

                            <div class="space-y-3 mb-6" id="participantList">
                                ${app.participants.map((participant, index) => `
                                    <div class="flex gap-2">
                                        <input
                                            type="text"
                                            id="name-${index}"
                                            value="${participant.name}"
                                            class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                            placeholder="ì°¸ê°€ì ${index + 1} ì´ë¦„"
                                        />
                                        ${app.participants.length > 1 ? `
                                            <button
                                                onclick="removeParticipant(${index})"
                                                class="px-4 py-3 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition whitespace-nowrap"
                                            >
                                                ì‚­ì œ
                                            </button>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>

                            <button
                                onclick="addParticipant()"
                                class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-200 transition mb-6"
                            >
                                + ì°¸ê°€ì ì¶”ê°€
                            </button>

                            <button
                                onclick="generateMatching()"
                                class="w-full bg-gradient-to-r from-pink-500 to-purple-500 text-white py-4 rounded-lg font-bold text-lg hover:from-pink-600 hover:to-purple-600 transition shadow-lg"
                            >
                                ğŸ ë§¤ì¹­ ìƒì„±í•˜ê¸°
                            </button>

                            <p class="text-xs text-gray-500 text-center mt-4">
                                ğŸ’¡ ë§í¬ë¥¼ ë°›ì€ í›„ ë³¸ì¸ ì´ë¦„ì„ ì…ë ¥í•´ì•¼ ë§ˆë‹ˆë˜ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </p>
                        </div>
                    </div>
                `;
            }
        }

        // ì´ˆê¸° ë¡œë“œ
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            if (params.get('data')) {
                app.step = 'view';
            }
            render();
        };
    </script>
</body>
</html>